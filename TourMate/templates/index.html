<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TourMate - Chatbot</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <!-- Sol panel (Mikrofon butonu ve reset) -->
      <div class="left-panel">
        <img class="logo" src="../static/logo.jpg" alt="logo" />
        <h2 class="logo-title">TourMate</h2>
        <div class="mic-button" id="mic-button">
          <i class="bx bxs-microphone"></i>
        </div>
        <!-- Mikrofon butonu arka plan olarak mikrofon ikonunuÂ kullanacakÂ -->
      </div>

      <!-- SaÄŸ panel (Soru ve cevaplar) -->
      <div class="right-panel">
        <div class="header">TourMate</div>

        <div class="chat-box" id="chat-box">
          <!-- Ã–rnek mesajlar -->
          <div class="bot-response">Merhaba, nasÄ±l yardÄ±mcÄ± olabilirim?</div>
        </div>

        <!-- Soru giriÅŸi ve gÃ¶nderme butonu -->
        <div class="input-area">
          <input type="text" id="user-input" placeholder="Bir soru sor..." />
          <button id="send-button">GÃ¶nder</button>
        </div>
      </div>
    </div>

    <script>
      const sendButton = document.getElementById('send-button');
      const userInput = document.getElementById('user-input');
      const chatBox = document.getElementById('chat-box');
      const micButton = document.getElementById('mic-button');

      // SpeechRecognition API kullanÄ±mÄ± (Web Speech API)
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'tr-TR'; // TÃ¼rkÃ§e dil ayarÄ±
      recognition.interimResults = false; // Sadece son sonucu almak iÃ§in

      // Mikrofona tÄ±klayÄ±nca dinlemeye baÅŸla
      micButton.addEventListener('click', () => {
        recognition.start(); // Dinleme baÅŸlasÄ±n
        micButton.classList.add('listening'); // Animasyonu baÅŸlat
      });

      // Ses algÄ±lanÄ±rsa input alanÄ±na yaz ve gÃ¶nderme iÅŸlemini tetikle
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript; // Sesli girdiyi al
        userInput.value = transcript; // AlÄ±nan sesli girdiyi input alanÄ±na yaz

        // "GÃ¶nder" butonunu programlÄ± olarak tetikle
        sendButton.click();
      };

      // Dinleme bittiÄŸinde animasyonu durdur
      recognition.onspeechend = () => {
        recognition.stop(); // KonuÅŸma bitince mikrofonu durdur
        micButton.classList.remove('listening'); // Animasyonu kaldÄ±r
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error detected: ' + event.error);
        micButton.classList.remove('listening'); // Hata durumunda animasyonu kaldÄ±r
      };

      // KullanÄ±cÄ± mesajÄ±nÄ± ekrana yazdÄ±ran fonksiyon
      function addUserMessage(message) {
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'user-input';
        userMessageDiv.textContent = message;
        chatBox.appendChild(userMessageDiv);
      }

      function addBotResponse(message, maps_url = null) {
        const botResponseDiv = document.createElement('div');
        botResponseDiv.className = 'bot-response';
        botResponseDiv.textContent = message;

        // EÄŸer bir maps linki varsa, onu ekleyelim
        if (maps_url) {
          const link = document.createElement('a');
          link.href = maps_url;
          link.target = '_blank';
          link.textContent = 'Haritaya buradan ulaÅŸabilirsiniz';
          link.style.color = 'white';
          link.style.textDecoration = 'underline';
          botResponseDiv.appendChild(document.createElement('br'));
          botResponseDiv.appendChild(document.createElement('br'));
          botResponseDiv.appendChild(link);
        }

        // Feedback butonlarÄ±nÄ± ekleyelim
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'feedback-buttons-container';
        feedbackDiv.innerHTML = `
        <button class="like-button">ğŸ‘</button>
        <button class="dislike-button">ğŸ‘</button>
      `;

        botResponseDiv.appendChild(feedbackDiv);
        chatBox.appendChild(botResponseDiv);

        // Otomatik olarak chat kutusunu en sona kaydÄ±r
        chatBox.scrollTop = chatBox.scrollHeight;

        // Bot cevabÄ±nÄ± sesli olarak oku
        speakText(message);
        // Butonlara olay dinleyicilerini ekleyelim
        feedbackDiv
          .querySelector('.like-button')
          .addEventListener('click', () => {
            sendFeedback('like', message);
          });

        feedbackDiv
          .querySelector('.dislike-button')
          .addEventListener('click', () => {
            const feedbackText = prompt(
              'Bu cevabÄ± neden beÄŸenmediniz? Ã–nerileriniz var mÄ±?'
            );
            const preferredResponse = prompt('NasÄ±l bir yanÄ±t beklerdiniz?');
            sendFeedback('dislike', message, feedbackText, preferredResponse);
          });
      }

      // Metni sesli okuma fonksiyonu
      function speakText(text) {
        const utterance = new SpeechSynthesisUtterance(text); // Okunacak metni ayarla
        utterance.lang = 'tr-TR'; // Dil ayarÄ± TÃ¼rkÃ§e
        window.speechSynthesis.speak(utterance); // Metni sesli olarak oku
      }

      // KullanÄ±cÄ±nÄ±n sorusunu API'ye gÃ¶nderme ve yanÄ±t alma
      async function sendQuestionToAPI(question) {
        const response = await fetch('/ask', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ question: question }),
        });

        const result = await response.json();
        console.log(result);
        if (result.answer) {
          // EÄŸer bir maps linki varsa, onu da ekleyelim
          addBotResponse(result.answer, result.maps_url);
        } else {
          addBotResponse('Bir hata oluÅŸtu.');
        }
      }

      // GÃ¶nder butonuna tÄ±klama olayÄ±
      sendButton.addEventListener('click', async () => {
        const userMessage = userInput.value.trim();
        if (userMessage) {
          // KullanÄ±cÄ± mesajÄ±nÄ± ekranda gÃ¶ster
          addUserMessage(userMessage);

          // API'ye soruyu gÃ¶nder ve cevabÄ± al
          await sendQuestionToAPI(userMessage);

          // GiriÅŸ kutusunu temizle
          userInput.value = '';
        }
      });

      // Konum izni isteme ve gÃ¶nderme fonksiyonu
      function requestLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;

              // Sunucuya konumu POST isteÄŸiyle gÃ¶nder
              fetch('/save_location', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lat: latitude, lng: longitude }),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.status === 'success') {
                    console.log(
                      'Konumunuz kaydedildi, ÅŸimdi rota Ã§izebilirsiniz.'
                    );
                  } else {
                    addBotResponse('Konum kaydedilemedi.');
                  }
                })
                .catch((error) => {
                  addBotResponse('Bir hata oluÅŸtu.');
                  console.error('Error:', error);
                });
            },
            (error) => {
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  addBotResponse('KullanÄ±cÄ± konum iznini reddetti.');
                  break;
                case error.POSITION_UNAVAILABLE:
                  addBotResponse('Konum bilgisi mevcut deÄŸil.');
                  break;
                case error.TIMEOUT:
                  addBotResponse('Konum alma isteÄŸi zaman aÅŸÄ±mÄ±na uÄŸradÄ±.');
                  break;
                case error.UNKNOWN_ERROR:
                  addBotResponse('Bilinmeyen bir hata oluÅŸtu.');
                  break;
              }
            }
          );
        } else {
          addBotResponse('TarayÄ±cÄ±nÄ±z bu Ã¶zelliÄŸi desteklemiyor.');
        }
      }

      // Sayfa yÃ¼klendiÄŸinde konum izni isteme
      window.onload = () => {
        requestLocation();
      };

      function sendFeedback(
        rating,
        responseMessage,
        feedbackText = '',
        preferredResponse = ''
      ) {
        const userFeedback = {
          rating: rating,
          feedback_text: feedbackText,
          preferred_response: preferredResponse,
          location: location,
        };

        fetch('/submit_feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(userFeedback),
        })
          .then((response) => response.json())
          .then((result) => {
            console.log('BaÅŸarÄ±yla gÃ¶nderildi:', result);
          })
          .catch((error) => {
            console.error('Hata:', error);
          });
      }
    </script>
  </body>
</html>
